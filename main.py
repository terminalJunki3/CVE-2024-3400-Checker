import gzip
import tarfile
import os

def search_in_tar_gz_file(filepath, search_terms, log_files):
    if not filepath.lower().endswith('gz'):
        print("Error: Please provide a .gz file.")
        return

    try:
        with gzip.open(filepath, 'rb') as f_in:
            with tarfile.open(fileobj=f_in, mode='r:*') as tar:
                print("Decompressing files...")
                for member in tar.getmembers():
                    if any(member.name.endswith(log_file) for log_file in log_files):
                        f = tar.extractfile(member)
                        if f:
                            lines = f.readlines()
                            matches = []
                            for line in lines:
                                decoded_line = line.decode('utf-8', errors='replace')
                                if any(term in decoded_line for term in search_terms):
                                    matches.append(decoded_line.strip())
                            if matches:
                                print("Potential Compromise Found. Please follow remediation guidance and share files with vendor.")
                                for match in matches:
                                    print(match)
                                return  # Found matches - Stopped searching
        print("Compromise Not Detected. Please share file with vendor to be certain.")
    except Exception as e:
        print(f"An error occurred, cannot show results: {e}")

# Replace this with your actual file path
filepath = r'path to techsupport.tgz'

log_files = ('md_out.log', 'md_out.log.old', 'gpsvc.log')
search_terms = ['wget','bash', 'device_telemetry/minute/','unmarshal']  # list of search terms

search_in_tar_gz_file(filepath, search_terms, log_files)